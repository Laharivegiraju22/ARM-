parameters:
  - name: sonar
    displayName: Do you want sonar to analyze for this build?
    default: true
    values:
      - true
      - false
    
trigger:
 branches:
   include:
     - master
 paths:
   exclude:
     - azure-pipelines.yaml
pool:
  vmImage: 'windows-latest'

stages:
 
 - stage: Build_WebApp
   displayName: 'build WebApp'
   variables:
       solution: '**/*.sln'
       buildPlatform: 'Any CPU'
       buildConfiguration: 'Release'
   jobs:
   - job: buildjob
     steps:
     - task: NuGetToolInstaller@1

     - task: NuGetCommand@2
       inputs:
         restoreSolution: '$(solution)'
         
     - ${{ if eq(parameters.sonar, true) }}:
       - task: SonarCloudPrepare@1
         displayName: sonarcloud Preparations
         inputs:
           SonarCloud: 'lahari-sonarcloud-connect'
           organization: 'lahariorg'
           scannerMode: 'MSBuild'
           projectKey: '789b25b1c0e5ba0a1b920e5b179c6d5f2e7b0a61'
           projectName: 'lahari-demo-p1'
         enabled: true
    

     - task: VSBuild@1
       inputs:
         solution: '$(solution)'
         msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
         platform: '$(buildPlatform)'
         configuration: '$(buildConfiguration)'
     - ${{ if eq(parameters.sonar, true) }}:
       - task: SonarCloudAnalyze@1
     - ${{ if eq(parameters.sonar, true) }}:
       - task: SonarCloudPublish@1
         inputs:
           pollingTimeoutSec: '300'
     - task: VSTest@2
       inputs:
         platform: '$(buildPlatform)'
         configuration: '$(buildConfiguration)'

     - task: DotNetCoreCLI@2
       inputs:
         command: 'publish'
         publishWebProjects: true
         arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'

     - task: PublishBuildArtifacts@1
       inputs:
         PathtoPublish: '$(Build.ArtifactStagingDirectory)'
         ArtifactName: 'drop'
         publishLocation: 'Container'


 - stage: Deploy_WebApp
   displayName: 'Deployment of WebApp'
 
   jobs:
   - deployment: prod
     displayName: Blue Deployment
     pool: 
       vmImage: windows-latest
   
     environment: 'prod'
     strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              itemPattern: '*.zip'
              downloadPath: '$(System.ArtifactsDirectory)'
            enabled: false 
          - task: AzureRmWebAppDeployment@4
            inputs:
              ConnectionType: 'AzureRM'
              azureSubscription: 'Free Trial (60584be9-98a4-4707-be50-badf2b4fb922)'
              appType: 'webApp'
              WebAppName: 'lahari-dotnet-yamldeploy'
              packageForLinux: 'D:\a\1\drop\pipeline.zip'
              enableCustomDeployment: true
              DeploymentType: 'webDeploy'
              RemoveAdditionalFilesFlag: true
              enableXmlVariableSubstitution: true
            enabled: false 